import re
import nmap
import pandas as pd


def check_valid_ip(ip):
    regex = re.compile(
        r"(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+(?:[A-Z]{2,6}\.?|[A-Z0-9-]{2,}\.?)|"  # domain...
        r"localhost|"  # localhost...
        r"\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})",  # ...or ip
        re.IGNORECASE,
    )

    return re.match(regex, ip) is not None


def nmap_scan(ip_addr, scan_types, speed, ports):
    output_dict = {}

    try:
        nm = nmap.PortScanner()
    except nmap.PortScannerError:
        print("Error: Nmap not found !")
        return {"Error", "Nmap not found !"}

    nm.scan(hosts=ip_addr, ports=ports, arguments=f"{scan_types} {speed}")
    print(f"Command: $ {nm.command_line()}")

    try:
        with open("output/scan.csv", "w") as output:
            pass
            output.write(nm.csv())
        with open("output/scan.csv", "r") as output:
            csv_out = pd.read_csv(output, delimiter=";")

            for i in range(len(csv_out)):
                output_dict[
                    csv_out["port"].values[i]
                ] = f"{csv_out['product'].values[i]} {csv_out['extrainfo'].values[i]} {csv_out['version'].values[i]}"
    except PermissionError:
        print("Error: Permission not granted !")
        return {"Error", "Permission not granted !"}

    return output_dict
